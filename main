import pygame
import random
import time

# Initialize
pygame.init()

# Create screen
screen = pygame.display.set_mode((800,600))

# Set icon and title
pygame.display.set_caption("Color Pyramid")
icon = pygame.image.load('ColorPyramid.png')
pygame.display.set_icon(icon)

BG     = pygame.Color("#2A9D8F")
pink   = pygame.Color("#FF006E")
yellow = pygame.Color("#FFBE0B")
blue   = pygame.Color("#8338EC")

# 2D List representation of the board:
grid = [[BG,BG,BG,BG,BG,BG,BG,BG,BG],
        [BG,BG,BG,BG,BG,BG,BG,BG,BG],
        [BG,BG,BG,BG,BG,BG,BG,BG,BG],
        [BG,BG,BG,BG,BG,BG,BG,BG,BG],
        [BG,BG,BG,BG,BG,BG,BG,BG,BG]]

# List of cells that didn't satisfy the conditions:
badCells = []

# Create random game board
def initBoard ():
    for i in range (5):
        for j in range (4-i, 4+i+1):
            grid[i][j] = random.choice([pink, yellow, blue])
    drawBoard()

# Draw the current board 
def drawBoard():
    x = 265
    y = 100
    for i in range (5):
        for j in range (9):
            pygame.draw.rect(screen, grid[i][j], [x, y, 25, 25])
            x += 30
        x = 265
        y += 30

# Check for bad cells
def findBadCells(): 
    # Check yellow condition separately for the relevant rows:
    i = 4
    while i >= 2:
        if not yellowCondition(i):
            for t in range (4-i, 4+i+1):
                badCells.append([i,t])
        # If yellow condition is satisfied, check other coditions:
        else:
            for j in range (4-i, 4+i+1):
                if checkCell(i,j):
                    badCells.append([i,j])
    # Now check rows 0,1:
    while i >= 0:
        for k in range (4-i, 4+i+1):
                if checkCell(i,k):
                    badCells.append([i,k])


# The next four finctions are used to actually check the conditions.

# Check if row i has more than 3 yellow cells:
def yellowCondition(i):
    yellowCount = 0
    for j in range (9):
        if grid[i][j] is yellow:
            yellowCount += 1
    if yellowCount >= 4:
        return False
    else: 
        return True

# Check relevant conditions in *specific cells*: 
def checkCell(i,j):
    color = grid[i][j]
    legalCell = False
    if color is blue and blueCondition(i,j):
        legalCell = True
    elif color is pink and pinkCondition(i,j):
        legalCell = True
    return legalCell

# Check if a blue cell is on the edge of the pyramid
def blueCondition(i,j):
    if i == 4 or j == -i + 4 or j == i + 4:
        return True
    else:
        return False

# Check if a pink cell has blue neighbors
def pinkCondition(i,j):
    up = i-1 if i > 0 else i
    down = i+1 if i < 4 else i
    left = j-1 if j > 0 else j
    right = j+1 if j < 8 else j

    if grid[up][j] is blue or grid[down][j] is blue or grid[i][left] is blue or grid[i][right] is blue:
        return True
    else:
        return False


# Update cells that don't satisfy conditions
def updateBoard(badCells):
    for item in badCells:
        i = item[0]
        j = item[1]
        grid[i][j] = random.choice([pink, yellow, blue])
    drawBoard()
        
    

# Set background color and initialize random board
screen.fill(BG)
initBoard()

# Game loop:
running = True
while running:
    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False          
    
    screen.fill(BG)

    # If the board doesn't satisfy all conditions, fix it
    findBadCells()
    if len(badCells) != 0:
        updateBoard()

    # Wait a moment
    time.sleep(0.5)
    pygame.display.update()
